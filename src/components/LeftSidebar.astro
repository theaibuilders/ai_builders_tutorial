---
import SearchBar from '../components/SearchBar.astro';
import type { TutorialFile, TutorialSection } from '../types/tutorial';

interface Props {
  sections: TutorialSection[];
  currentFile?: TutorialFile;
}

const { sections, currentFile } = Astro.props;
---

<div class="h-screen flex flex-col lg:pt-0">


  <!-- Header with Logo -->
  <div class="flex-shrink-0 border-b border-dark-border lg:block hidden" style="padding: 24px 24px 24px 24px;">
    <div class="flex items-center justify-between mb-4" style="height: 60px; margin-left: 0; padding-left: 0;">
      <a href="https://www.theaibuilders.dev/" target="_blank" rel="noopener noreferrer">
        <img 
          src="/ai-builders-tutorial-logo.png" 
          alt="AI Builders Tutorial Logo" 
          class="h-10 w-auto opacity-90 max-w-full object-contain"
          style="margin-left: 0; padding-left: 0;"
        />
      </a>
      <!-- Desktop Toggle Button -->
      <button
        id="desktop-sidebar-toggle"
        class="p-2 rounded-lg hover:bg-dark-hover transition-colors"
        aria-label="Toggle sidebar"
        onclick="toggleDesktopSidebar()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
      </button>
    </div>
    <!-- Search Bar -->
    <SearchBar sections={sections} id="desktop" />
  </div>

  <!-- Mobile Logo and Search Bar -->
  <div class="lg:hidden p-3 border-b border-dark-border flex flex-col items-start">
    <div class="w-full flex items-center justify-between mb-2">
      <a href="https://www.theaibuilders.dev/" target="_blank" rel="noopener noreferrer" class="py-2">
        <img 
          src="/ai-builders-tutorial-logo.png" 
          alt="AI Builders Tutorial Logo" 
          class="h-10 w-auto opacity-90 max-w-full object-contain"
          style="margin-left: 0; padding-left: 0;"
        />
      </a>
      <!-- Close Panel Button -->
      <button
        id="mobile-sidebar-close"
        class="p-2 rounded-lg hover:bg-dark-hover transition-colors"
        aria-label="Close sidebar"
        onclick="closeMobileNav()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
      </button>
    </div>
    <SearchBar sections={sections} id="mobile" />
  </div>
  
  <!-- Navigation Content -->
  <div class="flex-1 overflow-y-auto min-h-0">
    <nav class="p-4 pb-20">
      {sections.map((section) => (
        <div class="mb-6">
          <!-- Section Header -->
          <button 
            class="flex items-center justify-between w-full text-left p-3 sm:p-2 rounded-lg hover:bg-dark-hover transition-colors group"
            data-section={section.path}
            onclick="toggleSection(this)"
          >
            <span class="font-semibold text-dark-text capitalize">
              {section.name}
            </span>
            <svg 
              class="w-5 h-5 sm:w-4 sm:h-4 text-dark-secondary transform transition-transform group-data-[expanded]:rotate-90"
              fill="currentColor" 
              viewBox="0 0 20 20"
            >
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </button>
          
          <!-- Section Files -->
          <div 
            class="ml-4 mt-2 space-y-1 section-content" 
            data-section-content={section.path}
            style="display: none;"
          >
            {section.files.map((file) => {
              const isActive = currentFile && currentFile.path === file.path;
              // Remove file extension from path for URL
              const cleanPath = file.path.replace(/\.(md|mdx|ipynb)$/, '');
              
              return (
                <a
                  href={`/tutorials/${cleanPath}`}
                  class={`block p-3 sm:p-2 rounded-lg text-sm transition-colors ${
                    isActive 
                      ? 'bg-blue-500/10 text-blue-400 border-l-2 border-blue-400' 
                      : 'text-dark-secondary hover:bg-dark-hover hover:text-dark-text'
                  }`}
                  onclick="closeMobileNav()"
                >
                  <div class="flex items-center">
                    <!-- File Name -->
                    <span class="truncate">
                      {file.metadata.title}
                    </span>
                  </div>
                  
                  <!-- File Description (if available) -->
                  {file.metadata.description && (
                    <div class="mt-1 text-xs text-dark-secondary opacity-75 line-clamp-2">
                      {file.metadata.description}
                    </div>
                  )}
                </a>
              );
            })}
          </div>
        </div>
      ))}
    </nav>
  </div>

  <!-- Bottom Icons for Full Sidebar -->
  <div class="flex-shrink-0 border-t border-dark-border bg-dark-bg lg:block hidden">
    <div class="p-4">
      <div class="flex items-center gap-3">
        <a
          href="https://www.theaibuilders.dev/"
          target="_blank"
          rel="noopener noreferrer"
          class="w-8 h-8 flex items-center justify-center transition-colors hover:text-gray-100"
          aria-label="Visit AI Builders Website"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
        </a>
        <a
          href="https://github.com/devonsunml/ai_builders_tutorial"
          target="_blank"
          rel="noopener noreferrer"
          class="w-8 h-8 flex items-center justify-center transition-colors hover:text-gray-100"
          aria-label="View on GitHub"
        >
          <svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-gray-300">
            <path d="M12 0C5.37 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.6.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.108-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.565 21.796 24 17.298 24 12c0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
        <a
          href="https://www.linkedin.com/company/theaibuilders"
          target="_blank"
          rel="noopener noreferrer"
          class="w-8 h-8 flex items-center justify-center transition-colors hover:text-gray-100"
          aria-label="View on LinkedIn"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-gray-300"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>
        </a>
      </div>
    </div>
  </div>


  <!-- Mobile Close Button (if needed, keep only the button for mobile) -->
  <!--
  <div class="flex-shrink-0 border-t border-dark-border bg-dark-bg sticky bottom-0 lg:hidden">
    <div class="p-4">
      <div class="flex items-center justify-center relative">
        <button
          onclick="closeMobileNav()"
          class="absolute right-0 p-2 rounded-lg hover:bg-dark-hover transition-colors"
          aria-label="Close navigation"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  -->
</div>

<script>
  // Section toggle functionality
  function toggleSection(button: HTMLButtonElement) {
    const sectionPath = button.dataset.section;
    const content = document.querySelector(`[data-section-content="${sectionPath}"]`) as HTMLElement;
    const icon = button.querySelector('svg');
    
    if (content && icon) {
      const isExpanded = content.style.display !== 'none';
      content.style.display = isExpanded ? 'none' : 'block';
      
      if (isExpanded) {
        button.removeAttribute('data-expanded');
        icon.classList.remove('rotate-90');
      } else {
        button.setAttribute('data-expanded', 'true');
        icon.classList.add('rotate-90');
      }
    }
  }
  
  // Make functions available globally
  (window as any).toggleSection = toggleSection;
  
  // Initialize section states
  document.addEventListener('DOMContentLoaded', () => {
    // All sections start collapsed by default
    // Only expand the section containing the current file
    const currentFileLink = document.querySelector('a[href*="/tutorials/"].bg-blue-500\\/10');
    if (currentFileLink) {
      const section = currentFileLink.closest('.mb-6');
      if (section) {
        const button = section.querySelector('button[data-section]') as HTMLButtonElement;
        const content = section.querySelector('[data-section-content]') as HTMLElement;
        const icon = button?.querySelector('svg');
        
        if (button && content && icon) {
          content.style.display = 'block';
          button.setAttribute('data-expanded', 'true');
          icon.classList.add('rotate-90');
        }
      }
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
